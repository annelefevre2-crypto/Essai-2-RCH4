<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RCH • Photo → OCR + QR → Prompt ChatGPT</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--accent:#06b6d4;--ok:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    header{padding:16px 20px;background:linear-gradient(90deg,#0ea5e9,#06b6d4);color:#001018;font-weight:700}
    main{max-width:980px;margin:24px auto;padding:0 16px 40px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr 1fr}}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    h2{margin:0 0 10px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{background:#06b6d4;border:none;color:#001018;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.secondary{background:transparent;border:1px solid #334155;color:#e5e7eb}
    button:disabled{opacity:.5;cursor:not-allowed}
    video,canvas,.preview{width:100%;border-radius:12px;background:#0f172a;border:1px dashed #334155;min-height:260px;display:block}
    textarea{width:100%;min-height:220px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;padding:12px;font-size:14px}
    .hint{color:#94a3b8;font-size:12px}
    footer{opacity:.7;text-align:center;margin-top:16px;font-size:12px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b3b45;color:#aef;display:inline-block}
    .progress{height:6px;background:#0b1220;border-radius:999px;overflow:hidden;border:1px solid #1f2a3a}
    .bar{height:100%;width:0;background:#06b6d4;transition:width .3s ease}
  </style>
</head>
<body>
  <header>RCH • Photo → OCR + QR → Prompt ChatGPT</header>
  <main class="grid">
    <section class="card">
      <h2>1) Prendre la photo</h2>
      <div class="row">
        <button id="btnStart">Activer la caméra</button>
        <button id="btnShot" class="secondary" disabled>Capturer</button>
        <input id="file" type="file" accept="image/*" capture="environment" style="display:none">
        <button id="btnUpload" class="secondary">Importer une image</button>
        <span class="badge" id="camStatus">Caméra : inactif</span>
      </div>
      <div style="margin-top:10px">
        <video id="video" playsinline></video>
        <canvas id="canvas" class="preview" hidden></canvas>
      </div>
      <div class="hint">Astuce : sur iPhone/Android, utilisez “Importer” pour choisir ou prendre une photo si la caméra n’apparaît pas.</div>
    </section>

    <section class="card">
      <h2>2) OCR + Lecture QR</h2>
      <div class="row"><button id="btnProcess" disabled>Lancer le traitement</button>
      <button id="btnClear" class="secondary">Effacer</button></div>
      <div class="progress" style="margin:10px 0"><div id="bar" class="bar"></div></div>
      <div class="hint" id="status">Prêt.</div>
      <div style="margin-top:10px">
        <textarea id="result" placeholder="Le texte manuscrit (OCR) et le contenu du QR code apparaîtront ici…"></textarea>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <h2>3) Composer & envoyer à ChatGPT</h2>
      <div class="hint">Modèle de prompt (modifiable avant envoi) :</div>
      <textarea id="prompt"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnOpen">Ouvrir dans ChatGPT</button>
        <button id="btnCopy" class="secondary">Copier le prompt</button>
      </div>
    </section>
  </main>
  <footer>Fonctionne hors-ligne après première visite • Traitements OCR & QR en local • PWA installable</footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const btnStart = document.getElementById('btnStart');
  const btnShot = document.getElementById('btnShot');
  const btnUpload = document.getElementById('btnUpload');
  const fileInput = document.getElementById('file');
  const btnProcess = document.getElementById('btnProcess');
  const btnClear = document.getElementById('btnClear');
  const statusEl = document.getElementById('status');
  const bar = document.getElementById('bar');
  const result = document.getElementById('result');
  const promptEl = document.getElementById('prompt');
  const btnOpen = document.getElementById('btnOpen');
  const btnCopy = document.getElementById('btnCopy');
  const camStatus = document.getElementById('camStatus');

  let stream = null;
  let capturedImage = null;

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }

  function setStatus(msg,p=0){ statusEl.textContent = msg; bar.style.width = (p*100)+'%'; }
  function showCanvas(){ video.hidden = true; canvas.hidden = false; }
  function showVideo(){ video.hidden = false; canvas.hidden = true; }

  btnStart.onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
      video.srcObject = stream; await video.play();
      btnShot.disabled = false; camStatus.textContent = 'Caméra : actif';
    }catch(e){ alert('Caméra non disponible : ' + e.message); }
  };

  btnShot.onclick = () => {
    const w = video.videoWidth || 1280, h = video.videoHeight || 720;
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video,0,0,w,h); showCanvas();
    capturedImage = canvas.toDataURL('image/png');
    btnProcess.disabled = false;
  };

  btnUpload.onclick = () => fileInput.click();
  fileInput.onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width; canvas.height = img.height;
      ctx.drawImage(img,0,0); showCanvas();
      capturedImage = canvas.toDataURL('image/png');
      btnProcess.disabled = false;
    };
    img.src = URL.createObjectURL(file);
  };

  btnClear.onclick = () => {
    result.value = ''; promptEl.value=''; bar.style.width='0%'; setStatus('Prêt.'); btnProcess.disabled = !capturedImage;
  };

  async function doOCR(imageDataURL){
    return new Promise((resolve,reject)=>{
      Tesseract.recognize(imageDataURL,'fra+eng',{
        logger: m => { if(m.status==='recognizing text' && m.progress){ setStatus('OCR en cours…', m.progress); } }
      }).then(({ data:{ text } })=> resolve(text)).catch(reject);
    });
  }

  function readQR(){
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, canvas.width, canvas.height);
    return code ? code.data : '';
  }

  btnProcess.onclick = async () => {
    if(!capturedImage) return alert('Aucune image.');
    try{
      setStatus('Lecture du QR…', 0.05);
      const qr = readQR();
      setStatus('OCR en préparation…', 0.1);
      const text = await doOCR(capturedImage);
      setStatus('Compilation du résultat…', 1);

      const compiled = `# Texte manuscrit (OCR)
${text.trim()}

# Données QR
${qr || '(aucun code détecté)'} 
`; 
      result.value = compiled;

      const defaultPrompt = `Analyse cette fiche opérationnelle RCH (texte OCR + QR). 
Objectif: extraire les informations clés (produit, dangers, AEGL/IDLH si mentionnés, zones, moyens engagés, décisions) et proposer un plan d'action synthétique RCH3/RCH4.
---
${compiled}`.trim();

      promptEl.value = defaultPrompt;
      setStatus('Terminé.');
    }catch(err){
      console.error(err); alert('Erreur traitement: ' + err.message);
      setStatus('Erreur.');
    }
  };
  </script>
</body>
</html>
